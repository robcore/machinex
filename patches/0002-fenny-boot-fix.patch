From daaf3dc736d69f893e4aa9858fe786fe53c4f5d6 Mon Sep 17 00:00:00 2001
From: Fenny Fatal <Fenny@Fennyfatal.com>
Date: Tue, 25 Mar 2014 18:27:59 -0600
Subject: [PATCH] Replace the offending argument earlier in the boot process.

---
 include/s_funcs.h | 17 +++++++++++++++++
 init/main.c       |  2 ++
 2 files changed, 19 insertions(+)
 create mode 100644 include/s_funcs.h

diff --git a/include/s_funcs.h b/include/s_funcs.h
new file mode 100644
index 0000000..5586eaf
--- /dev/null
+++ b/include/s_funcs.h
@@ -0,0 +1,17 @@
+#include <linux/string.h>
+
+void replace_str(char *str, char *orig, char *rep)
+{
+  static char buffer[4096];
+  char *p;
+
+  if(!(p = strstr(str, orig)))
+    return;
+
+  strncpy(buffer, str, p-str);
+  buffer[p-str] = '\0';
+
+  sprintf(buffer+(p-str), "%s%s", rep, p+strlen(orig));
+
+  strncpy(str, buffer, strlen(buffer));
+}
diff --git a/init/main.c b/init/main.c
index d152d34..b2bde9c 100644
--- a/init/main.c
+++ b/init/main.c
@@ -68,6 +68,7 @@
 #include <linux/shmem_fs.h>
 #include <linux/slab.h>
 #include <linux/perf_event.h>
+#include <s_funcs.h>
 
 #include <asm/io.h>
 #include <asm/bugs.h>
@@ -580,6 +581,7 @@ asmlinkage void __init start_kernel(void)
 	boot_init_stack_canary();
 	mm_init_owner(&init_mm, &init_task);
 	mm_init_cpumask(&init_mm);
+        replace_str((char*)&boot_command_line,"androidboot.bootchg=true","androidboot.mode=charger");
 	setup_command_line(command_line);
 	setup_nr_cpu_ids();
 	setup_per_cpu_areas();
